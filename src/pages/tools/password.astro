---
import Layout from '../../layouts/Layout.astro';
import FAQ from '../../components/FAQ.astro';
import toolsData from '../../data/tools.json';

const tool = toolsData.find(t => t.id === 'password')!;

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'WebApplication',
  name: tool.name,
  description: tool.description,
  applicationCategory: 'DeveloperApplication',
  operatingSystem: 'Any',
  offers: {
    '@type': 'Offer',
    price: '0',
    priceCurrency: 'USD'
  },
  browserRequirements: 'Requires JavaScript',
  permissions: 'No special permissions required'
};

const faqJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: tool.faq.map(item => ({
    '@type': 'Question',
    name: item.question,
    acceptedAnswer: {
      '@type': 'Answer',
      text: item.answer
    }
  }))
};
---

<Layout title={tool.metaTitle} description={tool.metaDescription}>
  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
  <script type="application/ld+json" set:html={JSON.stringify(faqJsonLd)} />
  <div class="max-w-4xl mx-auto">
    <div class="mb-6">
      <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-2">ðŸ”‘ Password Generator</h1>
      <p class="text-gray-600 dark:text-gray-400">Generate strong, secure random passwords</p>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 space-y-6">
      <!-- Generated Password Display -->
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Generated Password</label>
        <div class="flex items-center space-x-2">
          <input
            type="text"
            id="generatedPassword"
            readonly
            class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg font-mono text-lg bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-primary-500"
          />
          <button
            id="copyBtn"
            class="px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
          >
            Copy
          </button>
          <button
            id="regenerateBtn"
            class="px-4 py-3 bg-primary-600 dark:bg-primary-500 text-white rounded-lg hover:bg-primary-700 transition-colors"
          >
            ðŸ”„
          </button>
        </div>
      </div>

      <!-- Password Strength -->
      <div>
        <div class="flex items-center justify-between mb-2">
          <label class="text-sm font-medium text-gray-700">Password Strength</label>
          <span id="strengthText" class="text-sm font-medium">Medium</span>
        </div>
        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2">
          <div id="strengthBar" class="bg-yellow-500 h-2 rounded-full transition-all" style="width: 50%"></div>
        </div>
      </div>

      <!-- Options -->
      <div class="space-y-4">
        <div>
          <div class="flex items-center justify-between mb-2">
            <label class="text-sm font-medium text-gray-700">Length: <span id="lengthValue">16</span></label>
          </div>
          <input
            type="range"
            id="length"
            min="8"
            max="128"
            value="16"
            class="w-full"
          />
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="flex items-center space-x-3 cursor-pointer">
            <input type="checkbox" id="includeUppercase" checked class="w-4 h-4 rounded" />
            <span class="text-sm text-gray-700">Uppercase (A-Z)</span>
          </label>

          <label class="flex items-center space-x-3 cursor-pointer">
            <input type="checkbox" id="includeLowercase" checked class="w-4 h-4 rounded" />
            <span class="text-sm text-gray-700">Lowercase (a-z)</span>
          </label>

          <label class="flex items-center space-x-3 cursor-pointer">
            <input type="checkbox" id="includeNumbers" checked class="w-4 h-4 rounded" />
            <span class="text-sm text-gray-700">Numbers (0-9)</span>
          </label>

          <label class="flex items-center space-x-3 cursor-pointer">
            <input type="checkbox" id="includeSymbols" checked class="w-4 h-4 rounded" />
            <span class="text-sm text-gray-700">Symbols (!@#$%...)</span>
          </label>

          <label class="flex items-center space-x-3 cursor-pointer">
            <input type="checkbox" id="excludeAmbiguous" class="w-4 h-4 rounded" />
            <span class="text-sm text-gray-700">Exclude ambiguous (0OIl)</span>
          </label>

          <label class="flex items-center space-x-3 cursor-pointer">
            <input type="checkbox" id="easyToRead" class="w-4 h-4 rounded" />
            <span class="text-sm text-gray-700">Easy to read</span>
          </label>
        </div>
      </div>

      <!-- Batch Generation -->
      <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
        <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-4">Batch Generation</h3>
        <div class="flex items-center space-x-4 mb-4">
          <label class="flex items-center space-x-2">
            <span class="text-sm text-gray-700">Count:</span>
            <input
              type="number"
              id="batchCount"
              value="10"
              min="1"
              max="100"
              class="w-20 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded"
            />
          </label>
          <button
            id="batchGenerateBtn"
            class="px-4 py-2 bg-primary-600 dark:bg-primary-500 text-white rounded-lg hover:bg-primary-700 transition-colors"
          >
            Generate Batch
          </button>
          <button
            id="copyAllBtn"
            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
          >
            Copy All
          </button>
        </div>
        <textarea
          id="batchOutput"
          rows="8"
          readonly
          class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg font-mono text-sm bg-gray-50 dark:bg-gray-700 dark:text-gray-100"
        ></textarea>
      </div>

      <!-- Tips -->
      <div class="bg-blue-50 dark:bg-blue-900 border border-blue-200 dark:border-blue-700 rounded-lg p-4">
        <h3 class="text-sm font-semibold text-blue-900 dark:text-blue-200 mb-2">Password Security Tips</h3>
        <ul class="text-sm text-blue-800 space-y-1 list-disc list-inside">
          <li>Use at least 16 characters for strong security</li>
          <li>Include a mix of uppercase, lowercase, numbers, and symbols</li>
          <li>Never reuse passwords across different sites</li>
          <li>Use a password manager to store your passwords securely</li>
          <li>Change passwords regularly, especially for sensitive accounts</li>
        </ul>
      </div>
    </div>

    <!-- FAQ Section -->
    <FAQ items={tool.faq} />
  </div>
</Layout>

<script>
  const generatedPassword = document.getElementById('generatedPassword');
  const lengthSlider = document.getElementById('length');
  const lengthValue = document.getElementById('lengthValue');
  const includeUppercase = document.getElementById('includeUppercase');
  const includeLowercase = document.getElementById('includeLowercase');
  const includeNumbers = document.getElementById('includeNumbers');
  const includeSymbols = document.getElementById('includeSymbols');
  const excludeAmbiguous = document.getElementById('excludeAmbiguous');
  const easyToRead = document.getElementById('easyToRead');
  const strengthBar = document.getElementById('strengthBar');
  const strengthText = document.getElementById('strengthText');
  const copyBtn = document.getElementById('copyBtn');
  const regenerateBtn = document.getElementById('regenerateBtn');
  const batchCount = document.getElementById('batchCount');
  const batchGenerateBtn = document.getElementById('batchGenerateBtn');
  const batchOutput = document.getElementById('batchOutput');
  const copyAllBtn = document.getElementById('copyAllBtn');

  const UPPERCASE = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  const LOWERCASE = 'abcdefghijklmnopqrstuvwxyz';
  const NUMBERS = '0123456789';
  const SYMBOLS = '!@#$%^&*()_+-=[]{}|;:,.<>?';
  const AMBIGUOUS = '0OIl1';
  const EASY_TO_READ = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';

  function generatePassword(): string {
    const length = parseInt(lengthSlider.value);
    let charset = '';

    if (easyToRead.checked) {
      charset = EASY_TO_READ;
    } else {
      if (includeUppercase.checked) charset += UPPERCASE;
      if (includeLowercase.checked) charset += LOWERCASE;
      if (includeNumbers.checked) charset += NUMBERS;
      if (includeSymbols.checked) charset += SYMBOLS;

      if (excludeAmbiguous.checked) {
        charset = charset.split('').filter(char => !AMBIGUOUS.includes(char)).join('');
      }
    }

    if (!charset) {
      return 'Please select at least one character type';
    }

    let password = '';
    const array = new Uint32Array(length);
    crypto.getRandomValues(array);

    for (let i = 0; i < length; i++) {
      password += charset[array[i] % charset.length];
    }

    return password;
  }

  function calculateStrength(password) {
    let score = 0;

    // Length
    if (password.length >= 16) score += 30;
    else if (password.length >= 12) score += 20;
    else if (password.length >= 8) score += 10;

    // Character variety
    if (/[a-z]/.test(password)) score += 15;
    if (/[A-Z]/.test(password)) score += 15;
    if (/[0-9]/.test(password)) score += 15;
    if (/[^A-Za-z0-9]/.test(password)) score += 25;

    if (score >= 80) return { score, text: 'Very Strong', color: 'bg-green-500' };
    if (score >= 60) return { score, text: 'Strong', color: 'bg-blue-500' };
    if (score >= 40) return { score, text: 'Medium', color: 'bg-yellow-500' };
    if (score >= 20) return { score, text: 'Weak', color: 'bg-orange-500' };
    return { score, text: 'Very Weak', color: 'bg-red-500' };
  }

  function updatePassword() {
    const password = generatePassword();
    generatedPassword.value = password;

    const strength = calculateStrength(password);
    if (strengthBar) {
      strengthBar.className = `${strength.color} h-2 rounded-full transition-all`;
      strengthBar.style.width = `${strength.score}%`;
    }
    if (strengthText) {
      strengthText.textContent = strength.text;
    }
  }

  lengthSlider?.addEventListener('input', () => {
    if (lengthValue) {
      lengthValue.textContent = lengthSlider.value;
    }
    updatePassword();
  });

  [includeUppercase, includeLowercase, includeNumbers, includeSymbols, excludeAmbiguous, easyToRead].forEach(checkbox => {
    checkbox?.addEventListener('change', updatePassword);
  });

  regenerateBtn?.addEventListener('click', updatePassword);

  copyBtn?.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(generatedPassword.value);
      const originalText = copyBtn.textContent;
      copyBtn.textContent = 'Copied!';
      setTimeout(() => {
        copyBtn.textContent = originalText;
      }, 2000);
    } catch (error) {
      console.error('Failed to copy');
    }
  });

  batchGenerateBtn?.addEventListener('click', () => {
    const count = Math.min(parseInt(batchCount.value), 100);
    const passwords = [];
    for (let i = 0; i < count; i++) {
      passwords.push(generatePassword());
    }
    batchOutput.value = passwords.join('\n');
  });

  copyAllBtn?.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(batchOutput.value);
      const originalText = copyAllBtn.textContent;
      copyAllBtn.textContent = 'Copied!';
      setTimeout(() => {
        copyAllBtn.textContent = originalText;
      }, 2000);
    } catch (error) {
      console.error('Failed to copy');
    }
  });

  // Generate initial password
  updatePassword();
</script>
