---
import Layout from '../../layouts/Layout.astro';
import FAQ from '../../components/FAQ.astro';
import toolsData from '../../data/tools.json';

const tool = toolsData.find(t => t.id === 'qr')!;

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'WebApplication',
  name: tool.name,
  description: tool.description,
  applicationCategory: 'DeveloperApplication',
  operatingSystem: 'Any',
  offers: {
    '@type': 'Offer',
    price: '0',
    priceCurrency: 'USD'
  },
  browserRequirements: 'Requires JavaScript',
  permissions: 'No special permissions required'
};

const faqJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: tool.faq.map(item => ({
    '@type': 'Question',
    name: item.question,
    acceptedAnswer: {
      '@type': 'Answer',
      text: item.answer
    }
  }))
};
---

<Layout title={tool.metaTitle} description={tool.metaDescription}>
  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
  <script type="application/ld+json" set:html={JSON.stringify(faqJsonLd)} />
  <div class="max-w-4xl mx-auto">
    <div class="mb-6">
      <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-2">ðŸ“± QR Code Generator</h1>
      <p class="text-gray-600 dark:text-gray-400 dark:text-gray-500 dark:text-gray-400">Generate QR codes from text or URLs</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Input Section -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Content</label>
          <textarea
            id="qrContent"
            rows="4"
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent dark:bg-gray-700 dark:text-gray-100"
            placeholder="Enter text or URL..."
          ></textarea>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Size (px)</label>
            <input
              type="number"
              id="qrSize"
              value="256"
              min="128"
              max="1024"
              step="32"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Error Correction</label>
            <select
              id="errorCorrection"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500"
            >
              <option value="L">Low (7%)</option>
              <option value="M" selected>Medium (15%)</option>
              <option value="Q">Quartile (25%)</option>
              <option value="H">High (30%)</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Foreground Color</label>
            <input
              type="color"
              id="fgColor"
              value="#000000"
              class="w-full h-10 px-1 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Background Color</label>
            <input
              type="color"
              id="bgColor"
              value="#FFFFFF"
              class="w-full h-10 px-1 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500"
            />
          </div>
        </div>

        <button
          id="generateBtn"
          class="w-full px-4 py-2 bg-primary-600 dark:bg-primary-500 text-white rounded-lg hover:bg-primary-700 transition-colors"
        >
          Generate QR Code
        </button>

        <div class="flex space-x-2">
          <button
            id="downloadBtn"
            class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:bg-gray-400"
            disabled
          >
            Download PNG
          </button>
          <button
            id="copySvgBtn"
            class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-400"
            disabled
          >
            Copy SVG
          </button>
        </div>
      </div>

      <!-- Preview Section -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
        <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-4">Preview</h3>
        <div class="flex items-center justify-center min-h-[300px] bg-gray-50 dark:bg-gray-700 rounded-lg">
          <div id="qrPreview" class="p-4">
            <p class="text-gray-400 dark:text-gray-500 text-center">QR code will appear here</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Links -->
    <div class="mt-6 bg-blue-50 dark:bg-blue-900 border border-blue-200 dark:border-blue-700 rounded-lg p-4">
      <h3 class="text-sm font-semibold text-blue-900 dark:text-blue-200 mb-2">Quick Generate</h3>
      <div class="flex flex-wrap gap-2">
        <button class="quick-link px-3 py-1 bg-white border border-blue-300 rounded-md text-sm hover:bg-blue-100" data-url="https://example.com">
          Website URL
        </button>
        <button class="quick-link px-3 py-1 bg-white border border-blue-300 rounded-md text-sm hover:bg-blue-100" data-url="mailto:email@example.com">
          Email
        </button>
        <button class="quick-link px-3 py-1 bg-white border border-blue-300 rounded-md text-sm hover:bg-blue-100" data-url="tel:+1234567890">
          Phone
        </button>
        <button class="quick-link px-3 py-1 bg-white border border-blue-300 rounded-md text-sm hover:bg-blue-100" data-url="WIFI:T:WPA;S:NetworkName;P:Password;;">
          WiFi
        </button>
      </div>
    </div>

    <!-- FAQ Section -->
    <FAQ items={tool.faq} />
  </div>
</Layout>

<script>
  import QRCode from 'qrcode';

  const qrContent = document.getElementById('qrContent');
  const qrSize = document.getElementById('qrSize');
  const errorCorrection = document.getElementById('errorCorrection');
  const fgColor = document.getElementById('fgColor');
  const bgColor = document.getElementById('bgColor');
  const generateBtn = document.getElementById('generateBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const copySvgBtn = document.getElementById('copySvgBtn');
  const qrPreview = document.getElementById('qrPreview');

  let currentCanvas = null;
  let currentSvg = '';

  async function generateQRCode() {
    const content = qrContent.value.trim();
    if (!content) {
      if (qrPreview) {
        qrPreview.innerHTML = '<p class="text-gray-400 dark:text-gray-500 text-center">Enter content to generate QR code</p>';
      }
      downloadBtn.disabled = true;
      copySvgBtn.disabled = true;
      return;
    }

    try {
      const size = parseInt(qrSize.value);
      const options = {
        errorCorrectionLevel: errorCorrection.value,
        width: size,
        color: {
          dark: fgColor.value,
          light: bgColor.value
        }
      };

      // Generate canvas
      const canvas = document.createElement('canvas');
      await QRCode.toCanvas(canvas, content, options);
      currentCanvas = canvas;

      // Generate SVG
      currentSvg = await QRCode.toString(content, { ...options, type: 'svg' });

      // Update preview
      if (qrPreview) {
        qrPreview.innerHTML = '';
        qrPreview.appendChild(canvas);
      }

      downloadBtn.disabled = false;
      copySvgBtn.disabled = false;
    } catch (error) {
      if (qrPreview) {
        qrPreview.innerHTML = '<p class="text-red-500 text-center">Error generating QR code</p>';
      }
      downloadBtn.disabled = true;
      copySvgBtn.disabled = true;
    }
  }

  generateBtn?.addEventListener('click', generateQRCode);

  downloadBtn?.addEventListener('click', () => {
    if (!currentCanvas) return;

    const link = document.createElement('a');
    link.download = 'qrcode.png';
    link.href = currentCanvas.toDataURL();
    link.click();
  });

  copySvgBtn?.addEventListener('click', async () => {
    if (!currentSvg) return;

    try {
      await navigator.clipboard.writeText(currentSvg);
      const originalText = copySvgBtn.textContent;
      copySvgBtn.textContent = 'Copied!';
      setTimeout(() => {
        copySvgBtn.textContent = originalText;
      }, 2000);
    } catch (error) {
      console.error('Failed to copy SVG');
    }
  });

  // Quick links
  document.querySelectorAll('.quick-link').forEach((button) => {
    button.addEventListener('click', () => {
      const url = button.dataset.url || '';
      qrContent.value = url;
      generateQRCode();
    });
  });
</script>
