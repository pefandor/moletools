---
import Layout from '../layouts/Layout.astro';
import ToolCard from '../components/ToolCard.astro';
import tools from '../data/tools.json';

// Group tools by category
const categories = tools.reduce((acc, tool) => {
  if (!acc[tool.category]) {
    acc[tool.category] = [];
  }
  acc[tool.category].push(tool);
  return acc;
}, {} as Record<string, typeof tools>);
---

<Layout title="Mole's Tools - Free Online Developer Tools" description="Collection of free online developer tools including JSON formatter, Base64 encoder, UUID generator, and more.">
  <!-- Loading Overlay -->
  <div id="loading-overlay" class="fixed inset-0 z-50 flex items-center justify-center" style="background: rgba(0,0,0,0.85) url('/images/mole/hero.png'); background-size: 120px 120px;">
    <h1 class="text-white font-bold text-6xl md:text-7xl" style="text-shadow: 0 4px 12px rgba(0,0,0,0.8);"><span data-i18n="splashText">Loading Mole's Tools...</span></h1>
  </div>

  <div class="space-y-8">
    <!-- Header -->
    <div class="flex flex-col md:flex-row items-center justify-between gap-8 p-8 rounded-2xl bg-gradient-to-br from-amber-50 to-white dark:from-amber-900/20 dark:to-gray-900">
      <div class="text-center md:text-left flex-1">
        <h1 class="text-4xl font-bold text-gray-900 dark:text-gray-100 mb-4">
          <span data-i18n="heroTitle">Your Trusty Mole for Every Dev Task</span>
        </h1>
        <p class="text-lg text-gray-600 dark:text-gray-400 max-w-2xl">
          <span data-i18n="heroDesc">{tools.length} free tools that work right in your browser. Fast, secure, no sign-up needed.</span>
        </p>
      </div>
      <div class="flex-shrink-0">
        <img src="/images/mole/hero.png" alt="Mole Hero" class="h-48 md:h-52 w-auto" />
      </div>
    </div>

    <!-- Search (placeholder for future enhancement) -->
    <div class="max-w-md mx-auto">
      <input
        type="text"
        id="toolSearch"
        data-i18n-placeholder="searchTools"
        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent"
      />
    </div>

    <!-- Recently Used Tools (populated by JS from localStorage) -->
    <div id="recent-tools-section" class="hidden reveal-section">
      <div class="flex items-center gap-3 mb-4">
        <span class="text-3xl">üïê</span>
        <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-200">
          <span data-i18n="recentlyUsed">Recently Used</span>
        </h2>
      </div>
      <div id="recent-tools-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>

    <!-- Tools by Category -->
    {Object.entries(categories).map(([category, categoryTools]) => (
      <div class="reveal-section">
        <div class="flex items-center gap-3 mb-4">
          <img
            src={`/images/mole/${category}.png`}
            alt={`${category} Mole`}
            class="h-14 w-auto"
          />
          <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-200">
            <span data-i18n={category.toLowerCase()}>{category}</span>
          </h2>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {categoryTools.map((tool) => (
            <ToolCard
              name={tool.name}
              description={tool.description}
              icon={tool.icon}
              category={tool.category}
              path={tool.path}
            />
          ))}
        </div>
      </div>
    ))}

    <!-- Stats -->
    <div class="reveal-section bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 mt-8">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
        <div>
          <div class="text-3xl font-bold text-primary-600 dark:text-primary-400">{tools.length}</div>
          <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">
            <span data-i18n="toolsAvailable">Tools Available</span>
          </div>
        </div>
        <div>
          <div class="text-3xl font-bold text-primary-600 dark:text-primary-400" style="white-space: nowrap;">
            <span data-i18n="clientSide">Fast & Secure</span>
          </div>
          <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">&nbsp;</div>
        </div>
        <div>
          <div class="text-3xl font-bold text-primary-600 dark:text-primary-400">
            <span data-i18n="freeToUse">100% Free to Use</span>
          </div>
          <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">&nbsp;</div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script is:inline>
  // Recently Used Tools
  (function() {
    var recent = [];
    try { recent = JSON.parse(localStorage.getItem('recentTools') || '[]'); } catch(e) {}
    if (!recent.length) return;

    // Tools data map (path ‚Üí tool info)
    var toolCards = document.querySelectorAll('a[href^="/tools/"]');
    var toolMap = {};
    toolCards.forEach(function(card) {
      var href = card.getAttribute('href');
      toolMap[href] = card.cloneNode(true);
    });

    var section = document.getElementById('recent-tools-section');
    var grid = document.getElementById('recent-tools-grid');
    if (!section || !grid) return;

    var hasCards = false;
    recent.forEach(function(path) {
      var card = toolMap[path];
      if (card) {
        grid.appendChild(card);
        hasCards = true;
      }
    });

    if (hasCards) {
      section.classList.remove('hidden');
    }
  })();

  // Index page translations
  (function() {
    // Add index-specific translations
    if (typeof MoleI18n !== 'undefined') {
      MoleI18n.addTranslations('en', {
        // Hero
        heroTitle: 'Your Trusty Mole for Every Dev Task',
        heroDesc: '35 free tools that work right in your browser. Fast, secure, no sign-up needed.',
        // Search
        searchTools: 'Search tools...',
        // Stats
        toolsAvailable: 'Tools Available',
        clientSide: 'Fast & Secure',
        freeToUse: '100% Free to Use',
        // Splash
        splashText: 'Loading Mole\'s Tools...',
        // Recent
        recentlyUsed: 'Recently Used'
      });

      MoleI18n.addTranslations('ru', {
        // Hero
        heroTitle: '–í–∞—à –ù–∞–¥—ë–∂–Ω—ã–π –ö—Ä–æ—Ç –¥–ª—è –õ—é–±—ã—Ö –ó–∞–¥–∞—á',
        heroDesc: '35 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –ë—ã—Å—Ç—Ä–æ, –±–µ–∑–æ–ø–∞—Å–Ω–æ, –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.',
        // Search
        searchTools: '–ü–æ–∏—Å–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤...',
        // Stats
        toolsAvailable: '–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤',
        clientSide: '–ë—ã—Å—Ç—Ä–æ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ',
        freeToUse: '100% –ë–µ—Å–ø–ª–∞—Ç–Ω–æ',
        // Splash
        splashText: '–ó–∞–≥—Ä—É–∑–∫–∞ Mole\'s Tools...',
        // Recent
        recentlyUsed: '–ù–µ–¥–∞–≤–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã'
      });

      // Set initial language
      var currentLang = MoleI18n.getCurrentLang();
      MoleI18n.setLanguage(currentLang);

      // Update placeholder
      var searchInput = document.getElementById('toolSearch');
      if (searchInput) {
        searchInput.placeholder = MoleI18n.t('searchTools');
      }

      // Listen for language changes to update placeholder
      document.addEventListener('languagechange', function() {
        if (searchInput) {
          searchInput.placeholder = MoleI18n.t('searchTools');
        }
      });
    }
  })();

  // Loading overlay
  (function() {
    var overlay = document.getElementById('loading-overlay');
    if (overlay) {
      // Block scroll
      document.body.style.overflow = 'hidden';

      // After 0.3 seconds, fade out
      setTimeout(function() {
        overlay.style.transition = 'opacity 0.3s ease';
        overlay.style.opacity = '0';

        // Remove from DOM after fade
        setTimeout(function() {
          if (overlay.parentNode) {
            overlay.parentNode.removeChild(overlay);
          }
          document.body.style.overflow = '';
        }, 300);
      }, 300);
    }
  })();

  // –ü—É–Ω–∫—Ç 4: Scroll reveal animations
  (function() {
    var sections = document.querySelectorAll('.reveal-section');
    if (!sections.length) return;

    // Respect reduced motion
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;

    // Set initial hidden state
    sections.forEach(function(el) {
      el.style.opacity = '0';
      el.style.transform = 'translateY(20px)';
      el.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
    });

    var observer = new IntersectionObserver(function(entries) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) {
          entry.target.style.opacity = '1';
          entry.target.style.transform = 'translateY(0)';

          // Stagger cards within this section
          var cards = entry.target.querySelectorAll('.tool-card');
          cards.forEach(function(card, i) {
            card.style.opacity = '0';
            card.style.transform = 'translateY(16px)';
            card.style.transition = 'opacity 0.4s ease ' + (i * 80) + 'ms, transform 0.4s ease ' + (i * 80) + 'ms';
            requestAnimationFrame(function() {
              requestAnimationFrame(function() {
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
              });
            });
          });

          observer.unobserve(entry.target);
        }
      });
    }, { threshold: 0.1, rootMargin: '0px 0px -50px 0px' });

    sections.forEach(function(el) { observer.observe(el); });
  })();

  // Simple search functionality
  var searchInput = document.getElementById('toolSearch');
  if (searchInput) {
    searchInput.addEventListener('input', function(e) {
      var searchTerm = e.target.value.toLowerCase();
      var toolCards = document.querySelectorAll('a[href^="/tools/"]');

      toolCards.forEach(function(card) {
        var text = card.textContent ? card.textContent.toLowerCase() : '';
        var parent = card.parentElement;
        if (text.includes(searchTerm)) {
          card.classList.remove('hidden');
        } else {
          card.classList.add('hidden');
        }
      });
    });
  }
</script>
