---
import Layout from '../layouts/Layout.astro';
import ToolCard from '../components/ToolCard.astro';
import tools from '../data/tools.json';

// Group tools by category
const categories = tools.reduce((acc, tool) => {
  if (!acc[tool.category]) {
    acc[tool.category] = [];
  }
  acc[tool.category].push(tool);
  return acc;
}, {} as Record<string, typeof tools>);
---

<Layout title="Mole's Tools - Free Online Developer Tools" description="Collection of free online developer tools including JSON formatter, Base64 encoder, UUID generator, and more.">
  <!-- Loading Overlay -->
  <div id="loading-overlay" class="fixed inset-0 z-50 flex items-center justify-center" style="background: rgba(0,0,0,0.85) url('/images/mole/hero.png'); background-size: 120px 120px;">
    <h1 class="text-white font-bold text-6xl md:text-7xl" style="text-shadow: 0 4px 12px rgba(0,0,0,0.8);"><span data-i18n="splashText">Loading Mole's Tools...</span></h1>
  </div>

  <div class="space-y-8">
    <!-- Header -->
    <div class="flex flex-col md:flex-row items-center justify-between gap-8 p-8 rounded-2xl bg-gradient-to-br from-amber-50 to-white dark:from-amber-900/20 dark:to-gray-900">
      <div class="text-center md:text-left flex-1">
        <h1 class="text-4xl font-bold text-gray-900 dark:text-gray-100 mb-4">
          <span data-i18n="heroTitle">Your Trusty Mole for Every Dev Task</span>
        </h1>
        <p class="text-lg text-gray-600 dark:text-gray-400 max-w-2xl">
          <span data-i18n="heroDesc">{tools.length} free tools that work right in your browser. Fast, secure, no sign-up needed.</span>
        </p>
      </div>
      <div class="flex-shrink-0">
        <img src="/images/mole/hero.png" alt="Mole Hero" class="h-48 md:h-52 w-auto" />
      </div>
    </div>

    <!-- Search -->
    <div class="max-w-md mx-auto">
      <div class="relative">
        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
        <input
          type="text"
          id="toolSearch"
          data-i18n-placeholder="searchTools"
          class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent"
        />
      </div>
    </div>

    <!-- No Results -->
    <div id="no-results" class="hidden text-center py-12">
      <img src="/images/mole/hero.png" alt="No results" class="h-24 mx-auto mb-4 opacity-50" />
      <p class="text-lg text-gray-500 dark:text-gray-400">
        <span data-i18n="noResults">No tools found</span>
      </p>
    </div>

    <!-- Favorite Tools (populated by JS from localStorage) -->
    <div id="fav-tools-section" class="hidden reveal-section">
      <div class="flex items-center gap-3 mb-4">
        <span class="text-3xl">‚≠ê</span>
        <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-200">
          <span data-i18n="favorites">Favorites</span>
        </h2>
      </div>
      <div id="fav-tools-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>

    <!-- Recently Used Tools (populated by JS from localStorage) -->
    <div id="recent-tools-section" class="hidden reveal-section">
      <div class="flex items-center gap-3 mb-4">
        <span class="text-3xl">üïê</span>
        <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-200">
          <span data-i18n="recentlyUsed">Recently Used</span>
        </h2>
      </div>
      <div id="recent-tools-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>

    <!-- Tools by Category -->
    {Object.entries(categories).map(([category, categoryTools]) => (
      <div class="reveal-section">
        <div class="flex items-center gap-3 mb-4">
          <img
            src={`/images/mole/${category}.png`}
            alt={`${category} Mole`}
            class="h-14 w-auto category-mole"
          />
          <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-200">
            <span data-i18n={category.toLowerCase()}>{category}</span>
          </h2>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {categoryTools.map((tool) => (
            <ToolCard
              name={tool.name}
              description={tool.description}
              icon={tool.icon}
              category={tool.category}
              path={tool.path}
            />
          ))}
        </div>
      </div>
    ))}

    <!-- Stats -->
    <div class="reveal-section bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 mt-8">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
        <div>
          <div class="text-3xl font-bold text-primary-600 dark:text-primary-400">{tools.length}</div>
          <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">
            <span data-i18n="toolsAvailable">Tools Available</span>
          </div>
        </div>
        <div>
          <div class="text-3xl font-bold text-primary-600 dark:text-primary-400" style="white-space: nowrap;">
            <span data-i18n="clientSide">Fast & Secure</span>
          </div>
          <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">&nbsp;</div>
        </div>
        <div>
          <div class="text-3xl font-bold text-primary-600 dark:text-primary-400">
            <span data-i18n="freeToUse">100% Free to Use</span>
          </div>
          <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">&nbsp;</div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script is:inline>
  // Build tool card map for favorites & recently used
  (function() {
    var toolCards = document.querySelectorAll('a[data-tool-path]');
    var toolMap = {};
    toolCards.forEach(function(card) {
      var href = card.getAttribute('data-tool-path');
      if (href) toolMap[href] = card;
    });

    function populateSection(sectionId, gridId, paths) {
      if (!paths.length) return;
      var section = document.getElementById(sectionId);
      var grid = document.getElementById(gridId);
      if (!section || !grid) return;
      var hasCards = false;
      paths.forEach(function(path) {
        var card = toolMap[path];
        if (card) {
          grid.appendChild(card.cloneNode(true));
          hasCards = true;
        }
      });
      if (hasCards) section.classList.remove('hidden');
    }

    // Favorites
    var favs = [];
    try { favs = JSON.parse(localStorage.getItem('favoriteTools') || '[]'); } catch(e) {}
    populateSection('fav-tools-section', 'fav-tools-grid', favs);

    // Recently Used
    var recent = [];
    try { recent = JSON.parse(localStorage.getItem('recentTools') || '[]'); } catch(e) {}
    populateSection('recent-tools-section', 'recent-tools-grid', recent);
  })();

  // Index page translations
  (function() {
    // Add index-specific translations
    if (typeof MoleI18n !== 'undefined') {
      MoleI18n.addTranslations('en', {
        // Hero
        heroTitle: 'Your Trusty Mole for Every Dev Task',
        heroDesc: '35 free tools that work right in your browser. Fast, secure, no sign-up needed.',
        // Search
        searchTools: 'Search tools...',
        // Stats
        toolsAvailable: 'Tools Available',
        clientSide: 'Fast & Secure',
        freeToUse: '100% Free to Use',
        // Splash
        splashText: 'Loading Mole\'s Tools...',
        // Recent & Favorites
        recentlyUsed: 'Recently Used',
        favorites: 'Favorites',
        noResults: 'No tools found'
      });

      MoleI18n.addTranslations('ru', {
        // Hero
        heroTitle: '–í–∞—à –ù–∞–¥—ë–∂–Ω—ã–π –ö—Ä–æ—Ç –¥–ª—è –õ—é–±—ã—Ö –ó–∞–¥–∞—á',
        heroDesc: '35 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –ë—ã—Å—Ç—Ä–æ, –±–µ–∑–æ–ø–∞—Å–Ω–æ, –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.',
        // Search
        searchTools: '–ü–æ–∏—Å–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤...',
        // Stats
        toolsAvailable: '–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤',
        clientSide: '–ë—ã—Å—Ç—Ä–æ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ',
        freeToUse: '100% –ë–µ—Å–ø–ª–∞—Ç–Ω–æ',
        // Splash
        splashText: '–ó–∞–≥—Ä—É–∑–∫–∞ Mole\'s Tools...',
        // Recent & Favorites
        recentlyUsed: '–ù–µ–¥–∞–≤–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã',
        favorites: '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ',
        noResults: '–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'
      });

      // Set initial language
      var currentLang = MoleI18n.getCurrentLang();
      MoleI18n.setLanguage(currentLang);

      // Update placeholder
      var searchInput = document.getElementById('toolSearch');
      if (searchInput) {
        searchInput.placeholder = MoleI18n.t('searchTools');
      }

      // Listen for language changes to update placeholder
      document.addEventListener('languagechange', function() {
        if (searchInput) {
          searchInput.placeholder = MoleI18n.t('searchTools');
        }
      });
    }
  })();

  // Loading overlay
  (function() {
    var overlay = document.getElementById('loading-overlay');
    if (overlay) {
      // Block scroll
      document.body.style.overflow = 'hidden';

      // After 0.3 seconds, fade out
      setTimeout(function() {
        overlay.style.transition = 'opacity 0.3s ease';
        overlay.style.opacity = '0';

        // Remove from DOM after fade
        setTimeout(function() {
          if (overlay.parentNode) {
            overlay.parentNode.removeChild(overlay);
          }
          document.body.style.overflow = '';
        }, 300);
      }, 300);
    }
  })();

  // –ü—É–Ω–∫—Ç 4: Scroll reveal animations
  (function() {
    var sections = document.querySelectorAll('.reveal-section');
    if (!sections.length) return;

    // Set initial hidden state
    sections.forEach(function(el) {
      el.style.opacity = '0';
      el.style.transform = 'translateY(20px)';
      el.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
    });

    var observer = new IntersectionObserver(function(entries) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) {
          entry.target.style.opacity = '1';
          entry.target.style.transform = 'translateY(0)';

          // Stagger cards within this section
          var cards = entry.target.querySelectorAll('.tool-card');
          cards.forEach(function(card, i) {
            card.style.opacity = '0';
            card.style.transform = 'translateY(16px)';
            card.style.transition = 'opacity 0.4s ease ' + (i * 80) + 'ms, transform 0.4s ease ' + (i * 80) + 'ms';
            requestAnimationFrame(function() {
              requestAnimationFrame(function() {
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
              });
            });
          });

          observer.unobserve(entry.target);
        }
      });
    }, { threshold: 0.1, rootMargin: '0px 0px -50px 0px' });

    sections.forEach(function(el) { observer.observe(el); });
  })();

  // Search with highlighting and no-results
  (function() {
    var searchInput = document.getElementById('toolSearch');
    var noResults = document.getElementById('no-results');
    if (!searchInput) return;

    // Store original text for each card
    var toolCards = document.querySelectorAll('a[data-tool-path]');
    var cardData = [];
    toolCards.forEach(function(card) {
      var h3 = card.querySelector('h3');
      var p = card.querySelector('p');
      cardData.push({
        el: card,
        h3: h3,
        p: p,
        origName: h3 ? h3.textContent : '',
        origDesc: p ? p.textContent : ''
      });
    });

    function highlightText(text, term) {
      if (!term) return text;
      var regex = new RegExp('(' + term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
      return text.replace(regex, '<mark class="bg-amber-300/40 dark:bg-amber-500/30 text-inherit rounded px-0.5">$1</mark>');
    }

    searchInput.addEventListener('input', function(e) {
      var term = e.target.value.toLowerCase().trim();
      var visibleCount = 0;

      cardData.forEach(function(data) {
        var nameMatch = data.origName.toLowerCase().includes(term);
        var descMatch = data.origDesc.toLowerCase().includes(term);
        if (!term || nameMatch || descMatch) {
          data.el.classList.remove('hidden');
          visibleCount++;
          if (term && data.h3) data.h3.innerHTML = highlightText(data.origName, term);
          if (term && data.p) data.p.innerHTML = highlightText(data.origDesc, term);
          if (!term) {
            if (data.h3) data.h3.textContent = data.origName;
            if (data.p) data.p.textContent = data.origDesc;
          }
        } else {
          data.el.classList.add('hidden');
        }
      });

      // Show/hide category headers
      var sections = document.querySelectorAll('.reveal-section');
      sections.forEach(function(section) {
        var visibleCards = section.querySelectorAll('a[data-tool-path]:not(.hidden)');
        if (term && visibleCards.length === 0) {
          section.style.display = 'none';
        } else {
          section.style.display = '';
        }
      });

      // No results
      if (noResults) {
        if (term && visibleCount === 0) {
          noResults.classList.remove('hidden');
        } else {
          noResults.classList.add('hidden');
        }
      }
    });
  })();
</script>
